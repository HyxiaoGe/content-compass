name: ğŸ¤– AIäº§å“ä¿¡æ¯è‡ªåŠ¨çˆ¬å–

on:
  # å®šæ—¶æ‰§è¡Œ - æ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
    - cron: '0 12 * * *' # æ¯å¤©UTC 12:00 (åŒ—äº¬æ—¶é—´ 20:00)
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      products:
        description: 'è¦çˆ¬å–çš„äº§å“ï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºä¸ºå…¨éƒ¨ï¼‰'
        required: false
        default: ''
      force:
        description: 'å¼ºåˆ¶é‡æ–°çˆ¬å–'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # PR/Pushæ—¶æµ‹è¯•ï¼ˆä»…æµ‹è¯•ä¸çˆ¬å–ï¼‰
  pull_request:
    branches: [master, main]
    paths:
      - 'netlify/functions/**'
      - 'src/lib/crawler/**'
      - '.github/workflows/crawl-products.yml'

jobs:
  crawl:
    name: ğŸ•·ï¸ çˆ¬å–AIäº§å“æ›´æ–°
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # PRæ—¶è·³è¿‡å®é™…çˆ¬å–
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“Š è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸš€ æ‰§è¡Œçˆ¬å–ä»»åŠ¡
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          echo "ğŸ¤– å¼€å§‹æ‰§è¡ŒAIäº§å“ä¿¡æ¯çˆ¬å–..."
          
          # æ„å»ºURLå‚æ•°
          PARAMS=""
          if [ "${{ github.event.inputs.products }}" != "" ]; then
            PARAMS="?products=${{ github.event.inputs.products }}"
          fi
          
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            if [ "$PARAMS" == "" ]; then
              PARAMS="?force=true"
            else
              PARAMS="${PARAMS}&force=true"
            fi
          fi
          
          # è°ƒç”¨Netlify Function
          FUNCTION_URL="https://content-compass.seanfield.org/.netlify/functions/crawl-products${PARAMS}"
          echo "ğŸ“¡ è°ƒç”¨URL: $FUNCTION_URL"
          
          # æ‰§è¡Œè¯·æ±‚å¹¶ä¿å­˜ç»“æœ
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" "$FUNCTION_URL")
          HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          RESPONSE_BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
          
          echo "ğŸ” HTTPçŠ¶æ€ç : $HTTP_STATUS"
          echo "ğŸ“„ å“åº”å†…å®¹:"
          echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
          
          # æ£€æŸ¥æ‰§è¡Œç»“æœ
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… çˆ¬å–ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
            
            # æå–ç»Ÿè®¡ä¿¡æ¯
            SUCCESS_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.results | map(select(.success == true)) | length' 2>/dev/null || echo "unknown")
            TOTAL_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.results | length' 2>/dev/null || echo "unknown")
            NEW_UPDATES=$(echo "$RESPONSE_BODY" | jq -r '.results | map(.newUpdates) | add' 2>/dev/null || echo "unknown")
            
            echo "ğŸ“ˆ ç»Ÿè®¡ç»“æœ: ${SUCCESS_COUNT}/${TOTAL_COUNT} ä¸ªäº§å“æˆåŠŸï¼Œæ–°å¢ ${NEW_UPDATES} æ¡æ›´æ–°"
            
            # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
            echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
            echo "new_updates=$NEW_UPDATES" >> $GITHUB_OUTPUT
          else
            echo "âŒ çˆ¬å–ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“¨ å‘é€é€šçŸ¥ï¼ˆå¦‚æœæœ‰æ–°æ›´æ–°ï¼‰
        if: success()
        env:
          NEW_UPDATES: ${{ steps.crawl.outputs.new_updates }}
        run: |
          if [ "$NEW_UPDATES" -gt 0 ] 2>/dev/null; then
            echo "ğŸ‰ å‘ç° $NEW_UPDATES æ¡æ–°æ›´æ–°ï¼Œå¯ä»¥è€ƒè™‘å‘é€é€šçŸ¥"
            # TODO: åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘ï¼ˆé‚®ä»¶ã€Slackã€å¾®ä¿¡ç­‰ï¼‰
          else
            echo "â„¹ï¸ æ²¡æœ‰å‘ç°æ–°æ›´æ–°"
          fi

  test:
    name: ğŸ§ª æµ‹è¯•çˆ¬å–åŠŸèƒ½
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # ä»…åœ¨PRæ—¶è¿è¡Œæµ‹è¯•
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“Š è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”§ TypeScriptæ£€æŸ¥
        run: npx tsc --noEmit

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          echo "ğŸ§ª æµ‹è¯•çˆ¬å–å™¨ä»£ç ..."
          # TODO: æ·»åŠ å•å…ƒæµ‹è¯•
          echo "âœ… æµ‹è¯•é€šè¿‡"

  # å¥åº·æ£€æŸ¥ä»»åŠ¡ - æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  health-check:
    name: ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    # ä»…åœ¨å®šæ—¶ä»»åŠ¡æ—¶è¿è¡Œ
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ” æ£€æŸ¥ç½‘ç«™å¯ç”¨æ€§
        run: |
          echo "ğŸ” æ£€æŸ¥ContentCompassç½‘ç«™çŠ¶æ€..."
          
          SITE_URL="https://content-compass.seanfield.org"
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")
          
          if [ "$STATUS_CODE" -eq 200 ]; then
            echo "âœ… ç½‘ç«™æ­£å¸¸è¿è¡Œ (HTTP $STATUS_CODE)"
          else
            echo "âŒ ç½‘ç«™å¼‚å¸¸ (HTTP $STATUS_CODE)"
            exit 1
          fi

      - name: ğŸ“Š æ£€æŸ¥æ•°æ®æ›´æ–°çŠ¶æ€
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "ğŸ“Š æ£€æŸ¥æœ€è¿‘çš„æ•°æ®æ›´æ–°..."
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ£€æŸ¥æœ€è¿‘æ›´æ–°æ—¶é—´çš„é€»è¾‘
          # ä¾‹å¦‚ï¼šæ£€æŸ¥æ•°æ®åº“ä¸­æœ€æ–°æ›´æ–°æ˜¯å¦åœ¨24å°æ—¶å†…
          
          echo "â„¹ï¸ æ•°æ®çŠ¶æ€æ£€æŸ¥å®Œæˆ"